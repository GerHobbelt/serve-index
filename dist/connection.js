/*!
 * serve-index
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 */
/*!
 *
 * serve-directory
 * Copyright(c) 2017- fisker Cheung
 * MIT Licensed
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_utils=require("./utils.js"),_utils2=_interopRequireDefault(_utils),_httpErrors=require("http-errors"),_httpErrors2=_interopRequireDefault(_httpErrors),_accepts=require("accepts"),_accepts2=_interopRequireDefault(_accepts);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var Connection=function(){function a(b,c,d,e){_classCallCheck(this,a),this.sd=b,this.req=c,this.res=d,this.next=e,this.url=_utils2.default.parseUrl.original(this.req)}return _createClass(a,[{key:"getMethod",value:function(){var a=this.req.method;return"GET"!==a&&"HEAD"!==a?(this.res.statusCode="OPTIONS"===a?200:405,this.res.setHeader("Allow","GET, HEAD, OPTIONS"),this.res.setHeader("Content-Length","0"),void this.res.end()):this.method=a}},{key:"getPathname",value:function(){var a=this.url,b=decodeURIComponent(a.pathname);return this.sd.options.hidden&&"."===b.slice(0,1)?(_utils2.default.debug("hidden folder \"%s\" deny.",b),void this.next((0,_httpErrors2.default)(403))):-1===b.indexOf("\0")?this.pathname=b:(_utils2.default.debug("null byte(s) in \"%s\", bad request.",b),void this.next((0,_httpErrors2.default)(400)))}},{key:"getResponseType",value:function(){var a=Object.keys(this.sd.responser),b=(0,_accepts2.default)(this.req).type(a);return b?this.responseType=b:(_utils2.default.debug("mime not acceptable \"%s\".",b),void this.next((0,_httpErrors2.default)(406)))}},{key:"getResponser",value:function(){var a=this.sd.responser[this.responseType];return this.responser=a}},{key:"getPath",value:function(){var a=_utils2.default.path.normalize(_utils2.default.path.join(this.sd.root,this.pathname));return(a+_utils2.default.path.sep).slice(0,this.sd.root.length)===this.sd.root?this.path=a:(_utils2.default.debug("malicious path \"%s\".",this.pathname),void this.next((0,_httpErrors2.default)(403)))}},{key:"getDirectory",value:function(){_utils2.default.debug("get directory \"%s\".",this.path);var a;try{a=_utils2.default.fs.statSync(this.path)}catch(a){return"ENOENT"===a.code||"ENOTDIR"===a.code?void this.next():(a.status="ENAMETOOLONG"===a.code?414:500,void this.next(a))}return a.isDirectory()?"/"===this.pathname.slice(-1)?(a.path=this.path,a.pathname=this.pathname,a.url=this.sd.options.relative?".":this.url.pathname,this.directory=a):(_utils2.default.debug("add \"/\" to \"%s\".",this.pathname),this.res.writeHead(301,{Location:this.url.pathname+"/"}),void this.res.end()):void this.next()}},{key:"getFiles",value:function(){_utils2.default.debug("get files \"%s\"",this.path);var a,b=this.path,c=this.sd.options.relative?"":this.url.pathname;try{a=_utils2.default.fs.readdirSync(b).map(function(a){var d=_utils2.default.fs.statSync(_utils2.default.path.join(b,a));return d.name=a,d.ext=_utils2.default.path.extname(a),d.type=_utils2.default.mime(d.ext),d.url=c+encodeURIComponent(a)+(d.isDirectory()?"/":""),d}).sort(_utils2.default.sortFile)}catch(a){return void this.next(a)}return this.sd.options.hidden||(a=a.filter(_utils2.default.notHidden)),this.files=a}},{key:"response",value:function(){if(this.getMethod()&&this.getPathname()&&this.getResponseType()&&this.getResponser()&&this.getPath()&&this.getDirectory()&&this.getFiles())try{this.responser(this.req,this.res,{path:this.path,pathname:this.pathname,url:this.url,method:this.method,responseType:this.responseType,directory:this.directory,files:this.files})}catch(a){a.status=500,this.next(a)}}}]),a}();exports.default=Connection,module.exports=exports["default"];