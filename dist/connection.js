/*!
 * serve-index
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 */
/*!
 *
 * serve-directory
 * Copyright(c) 2017- fisker Cheung
 * MIT Licensed
 */
"use strict";var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _=require("./utils.js"),httpError=require("http-errors"),accepts=require("accepts"),Connection=function(){function a(b,c,d,e){_classCallCheck(this,a),this.sd=b,this.req=c,this.res=d,this.next=e,this.url=_.parseUrl.original(this.req)}return _createClass(a,[{key:"getMethod",value:function(){var a=this.req.method;return"GET"!==a&&"HEAD"!==a?(this.res.statusCode="OPTIONS"===a?200:405,this.res.setHeader("Allow","GET, HEAD, OPTIONS"),this.res.setHeader("Content-Length","0"),void this.res.end()):this.method=a}},{key:"getPathname",value:function(){var a=this.url,b=decodeURIComponent(a.pathname);return this.sd.options.showHiddenFiles||"."!==b.slice(0,1)?-1===b.indexOf("\0")?this.pathname=b:(_.debug("null byte(s) in \"%s\", bad request.",b),void this.next(httpError(400))):(_.debug("hidden folder \"%s\" deny.",b),void this.next(httpError(403)))}},{key:"getResponseType",value:function(){var a=Object.keys(this.sd.responser),b=accepts(this.req).type(a);return b?this.responseType=b:(_.debug("mime not acceptable \"%s\".",b),void this.next(httpError(406)))}},{key:"getResponser",value:function(){var a=this.sd.responser[this.responseType];return this.responser=a}},{key:"getPath",value:function(){var a=_.path.normalize(_.path.join(this.sd.root,this.pathname));return(a+_.path.sep).slice(0,this.sd.root.length)===this.sd.root?this.path=a:(_.debug("malicious path \"%s\".",this.pathname),void this.next(httpError(403)))}},{key:"getDirectory",value:function(){_.debug("get directory \"%s\".",this.path);var a;try{a=_.fs.statSync(this.path)}catch(a){return"ENOENT"===a.code||"ENOTDIR"===a.code?void this.next():(a.status="ENAMETOOLONG"===a.code?414:500,void this.next(a))}return a.isDirectory()?"/"===this.pathname.slice(-1)?(a.path=this.path,a.pathname=this.pathname,a.url=this.sd.options.useRelativeUrl?".":this.url.pathname,this.directory=a):(_.debug("add \"/\" to \"%s\".",this.pathname),this.res.writeHead(301,{Location:this.url.pathname+"/"}),void this.res.end()):void this.next()}},{key:"getFiles",value:function(){_.debug("get files \"%s\"",this.path);var a,b=this.path,c=this.sd.options.useRelativeUrl?"":this.url.pathname;try{a=_.fs.readdirSync(b).map(function(a){var d=_.fs.statSync(_.path.join(b,a));return d.name=a,d.ext=_.path.extname(a),d.type=_.mime(d.ext),d.url=c+encodeURIComponent(a)+(d.isDirectory()?"/":""),d}).sort(_.sortFile)}catch(a){return void this.next(a)}return this.sd.options.showHiddenFiles||(a=a.filter(_.notHidden)),this.files=a}},{key:"response",value:function(){if(this.getMethod()&&this.getPathname()&&this.getResponseType()&&this.getResponser()&&this.getPath()&&this.getDirectory()&&this.getFiles())try{this.responser(this.req,this.res,{path:this.path,pathname:this.pathname,url:this.url,method:this.method,responseType:this.responseType,directory:this.directory,files:this.files})}catch(a){a.status=500,this.next(a)}}}]),a}();module.exports=Connection;